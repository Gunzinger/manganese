name: Build

on:
  push:
    branches: [ master, main ]
  pull_request:
    branches: [ master, main ]

jobs:
  build-linux:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential libomp-dev cmake

      - name: Get OpenBLAS submodule commit
        id: openblas-commit
        run: |
          echo "OPENBLAS_HASH=$(git submodule status OpenBLAS | awk '{print $1}')" >> $GITHUB_ENV

      - name: Cache OpenBLAS
        id: cache-openblas
        uses: actions/cache@v4
        with:
          path: OpenBLAS/libopenblas.a
          key: openblas-${{ runner.os }}-${{ env.OPENBLAS_HASH }}
      
      - name: Build OpenBLAS (if not cached)
        if: steps.cache-openblas.outputs.cache-hit != 'true'
        run: |
          make -C OpenBLAS USE_OPENMP=1 USE_THREAD=1 NO_LAPACK=1 DYNAMIC_ARCH=1 ONLY_CBLAS=1 NO_SHARED=1 USE_TLS=1 -j$(nproc)
        continue-on-error: true
      
      - name: Configure CMake
        run: |
          cmake -B build -S . -DCMAKE_BUILD_TYPE=Release -DBUILD_V3_TARGET=ON -DBUILD_V4_TARGET=ON

      - name: Build binaries
        run: |
          cmake --build build -j$(nproc)
      
      - name: Upload Linux binaries
        uses: actions/upload-artifact@v4
        with:
          name: manganese-linux
          path: |
            build/manganese-avx2
            build/manganese-avx512
          retention-days: 7

  build-windows:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0
      
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential cmake mingw-w64

      - name: Get OpenBLAS submodule commit
        id: openblas-commit
        run: |
          echo "OPENBLAS_HASH=$(git submodule status OpenBLAS | awk '{print $1}')" >> $GITHUB_ENV

      - name: Cache OpenBLAS Windows
        id: cache-openblas-win
        uses: actions/cache@v4
        with:
          path: OpenBLAS/libopenblas.a
          key: openblas-windows-cross-${{ env.OPENBLAS_HASH }}
      
      - name: Build OpenBLAS for Windows (if not cached)
        if: steps.cache-openblas-win.outputs.cache-hit != 'true'
        run: |
          make -C OpenBLAS USE_OPENMP=1 USE_THREAD=1 NO_LAPACK=1 DYNAMIC_ARCH=1 ONLY_CBLAS=1 NO_SHARED=1 USE_TLS=1 CC=x86_64-w64-mingw32-gcc FC=x86_64-w64-mingw32-gfortran -j$(nproc)
        continue-on-error: true
      
      - name: Configure CMake for Windows cross-compilation
        run: |
          cmake -B build-windows -S . \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_SYSTEM_NAME=Windows \
            -DCMAKE_C_COMPILER=x86_64-w64-mingw32-gcc \
            -DCMAKE_CXX_COMPILER=x86_64-w64-mingw32-g++ \
            -DCMAKE_FIND_ROOT_PATH=/usr/x86_64-w64-mingw32 \
            -DCMAKE_FIND_ROOT_PATH_MODE_PROGRAM=NEVER \
            -DCMAKE_FIND_ROOT_PATH_MODE_LIBRARY=ONLY \
            -DCMAKE_FIND_ROOT_PATH_MODE_INCLUDE=ONLY \
            -DBUILD_V3_TARGET=ON \
            -DBUILD_V4_TARGET=ON

      - name: Build Windows binaries
        run: |
          cmake --build build-windows -j$(nproc)
      
      - name: Upload Windows binaries
        uses: actions/upload-artifact@v4
        with:
          name: manganese-windows
          path: |
            build-windows/manganese-avx2.exe
            build-windows/manganese-avx512.exe
          retention-days: 7
          if-no-files-found: warn
